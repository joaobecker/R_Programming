---
title: "capstone_project"
author: "becker"
date: '2018-08-03'
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
load("wp_data1.RData")
load("upgraded_11.RData")
load("cust_can.RData")
library("mice")
library("dplyr")
library("tidyr")
library("ggplot2")
library("caTools")
library("ROCR")
```

### What is Wishpond?

  Wishpond is an All-in-one Marketing Suite for Retailers and Brand. The suite includes social contest and promotions app that permits you to run unlimited vote contests, sweepstakes, and campaigns. It additionally supplies a number of alternative tools such as landing page creators, email marketing and marketing automation.

### The Problem?

  Wishpond has thousands of customers that use the platform regularly. However, not much has been done to understand its customers and their actions in the platform. Therefore, this capstone project through data analysis, will investigate the different categories customers belong to and their main actions. In addition, it will use machine learning to indentify where customers will fall on and provide Wishpond with substantial data to focus on more specifics subjects that may generate more revenue.

### The Data Set

  The dataset for this project was acquired from Woopra, a customer service analytics that was installed in the Wishpond platform to track its customers’ actions. The database contains a total of 14,417 observations and 21 variables. For better understanding of the database, we will go over 8 of the most important variables to understand Wishpond’s customer.

##### Plan Name – (plan_name)

  Plan name identifies which plan the customer currently belongs to. Customers on Wishpond can belong to 4 different plans, they are: the starter plan, which is the plan for people that are just testing the platform and for those who have cancelled their plan. Basic plan, is the cheapest plan with a maximum amount of 1000 leads. Pro, is the intermediate plan, and it offers a maximum of 2500 leads. Growth plan offers unlimited leads. 

#####	Business Industry – (business_industry)

  Business industry identifies which industry customers belong to such as e-commerce, B2B, spa, fitness and others.

#####	Affiliated – (affiliated)

  Affiliated variable shows us if the customer has signed-up on Wishpond via an affiliated link or not. 

##### Sales – (sales)

  Sales variable shows us if the customer has signed-up on Wishpond after a demo with one of the sales agent at Wishpond. 

##### Read the blog – (read_blog)

  The read the blog variable identify those who have visited the Wishpond blog at one point in time. Wishpond blog is mostly about case-studies and content on lead generation 
techniques. 

##### Total Leads – (total_leads)

  Total leads represent the total amount of leads that the customer has acquired through Wishpond landing page or contest.

##### Total tools – (total_live_tools)

  Total tools represent the total amount of live tools, such as contests, pop-ups, workflows, forms and landing pages, that customers have under their account.

##### Unsubscribed – (Unsubscribed)

Unsubscribed identifies if a customer has unsubscribed from Wishpond or not.

### Data Limitation

  The limitation of the database is the large amount of missing data. The plan name variable is missing a third of its data, and other variables have an even larger number of missing data. In addition, a large amount of data from customers that have unsubscribed is lost, as Wishpond reset to zero the total leads and total tools they had under their account. Therefore, making it harder to determine if tools creation and amount of leads plays a role on their subscription.

### Data Wrangling

#### First Part

  The main database is formed by three different tables. These tables are: wp_data, upgrade_1 and cust_can. The wp_data and upgrade_1 tables have the same variables, the difference between them is that upgrade_1 has more information about customers that have upgraded to a paid account, while wp_data is more focused on clients that have assigned the type of industry they belong to. Lastly the cust_can table represents all the customer that have unsubscribed from Wishpond. Below shows the code of how these tables were combined into one.
  First we transformed the factor variables from the three tables into characters in order to not lose any information when comparing the variables from different tables.

```{r, echo=FALSE}
upgraded_1 <- upgraded_11
wp_data <- wp_data1
```

```{r}
#Transforming variables into characters to be able to use join function
wp_data[c(1:6, 12:16, 19)] <- lapply(wp_data[c(1:6, 12:16, 19)], as.character)
upgraded_1[c(1:6, 12:16, 19)] <- lapply(upgraded_1[c(1:6, 12:16, 19)], as.character)
cust_can$pid <- as.character(cust_can$pid)
```

	Second, we run the anti_join function to remove any duplicates from the upgrade_1 table and then we add the table to the wp_data with bind_rows function.

```{r}
# Here, we used anti_join to avoid having duplicates.
upgraded_1 <- anti_join(upgraded_1, wp_data, by = "pid")

#Combining Rows from different tables
wp_data <- bind_rows(wp_data, upgraded_1)
```

	Third, to know all the customers from the database that have unsubscribed, it was used the left_join function. Therefore, maintaining all the observations on wp_data while adding a new column, Unsubscribed. 

```{r}
# Using left_join to maintain all the current data from "wp_data" while adding a new column, Unsubscribed, from "cust_can"
wp_data <- left_join(wp_data, cust_can, by = c("pid" = "pid"))
```

  Lastly, during the join, empty columns were added. Thus, we get rid off with the code below.
```{r}
# Get rid off unwanted columns
wp_data <- wp_data[, -c(22:34)]

```

#### Second Part

  The database contained a lot of missing data, which made it difficult to read it. Therefore, empty values and NAs were replaced in order to create a more meaningful database. 


  For the missing data and NAs value on business industry, it was assigned the value “Unknown” 
```{r}
wp_data$business_industry <- gsub("^$", "Unknown", wp_data$business_industry)
wp_data <- wp_data %>%  replace_na(list(business_industry = "Unknown"))
```

  For the missing data on selected_service, it was assigned the value “Unknown” 
```{r}
wp_data$selected_service <- gsub("^$", "Unknown", wp_data$selected_service)
```

  For all the missing and null data on business_size, it was assigned the value “Unknown”
```{r}
wp_data$business_size[wp_data$business_size == "null"] <- "Unknown"
wp_data$business_size <- gsub("^$", "Unknown", wp_data$business_size)
```

  For the missing data on cancel_contact_support, it was assigned the value “No”, as only if a customer that has contacted support received a value of "Yes"
```{r}
wp_data$current_cancel_contact_support <- gsub("^$", "No", wp_data$current_cancel_contact_support)
```

  For the missing data on current_cancel_feeling, it was assigned the value “Unknown”
```{r}
wp_data$current_cancel_feeling <- gsub("^$", "Unknown", wp_data$current_cancel_feeling)
```

  For the missing data on has_seen_the_blog_overlay, it was assigned the value “FALSE” as all customers that have read the blog receveid the "TRUE" value
```{r}
wp_data <- wp_data %>%  replace_na(list(has_seen_the_blog_overlay = "FALSE"))
```

  For the missing data on support_agent_name, it was assigned the value “Unknown”
```{r}
wp_data$support_agent_name <- gsub("^$", "Unknown", wp_data$support_agent_name)
```

  For the missing data on locale, it was assigned the value “Unknown”
```{r}
wp_data$locale <- gsub("^$", "Unknown", wp_data$locale)
```

  For the missing data on plan_name, it was assigned the value “Unknown”
```{r}
wp_data$plan_name <- gsub("^$", "Unknown", wp_data$plan_name)
```

  For the missing data on sales_agent, it was assigned the value “Unknown”
```{r}
wp_data$sales_agent <- gsub("^$", "Unknown", wp_data$sales_agent)
```


  For the missing data on interest, it was assigned the value “Unknown”
```{r}
wp_data$interest <- gsub("^$", "Unknown", wp_data$interest)
```

  For the missing data on sales, it was assigned the value “FALSE” as all customers that have subscribed after a demo receveid the "TRUE" value
```{r}
wp_data <- wp_data %>%  replace_na(list(sales = "FALSE"))
```

  For the missing data on affiliated, it was assigned the value “FALSE” as all customers that have subscribed after coming thorugh an affiliated link receveid the "TRUE" value
```{r}
wp_data <- wp_data %>%  replace_na(list(affiliated = "FALSE"))
```

  For the missing data on Unsubscribed, it was assigned the value “FALSE” as all customers that have unsubscribed from Wishpond receveid the "TRUE" value
```{r}
wp_data <- wp_data %>% replace_na(list(Unsubscribed = "FALSE"))
```

#### Third Part	
  
  Some variables had a lot of different levels that could be represented by a unique level. Thus, the levels of these variables were summarized by using the code below:
	
  All the values containing a website will be replace with the "TRUE" value, while assigning "FALSE" to the empty rows
```{r}
wp_data$website[wp_data$website != ""] <- "TRUE"
wp_data$website[wp_data$website != "TRUE"] <- "FALSE"
```

  It will be assigned the "Self Service" value to all the rows containing "self" and "Fully Managed" to all the rows containing "fully"
```{r}
wp_data$selected_service <- gsub(".*self.*", "Self Service", wp_data$selected_service)
wp_data$selected_service <- gsub(".*fully.*", "Fully Managed", wp_data$selected_service)
```

  Some plans at Wishpond have a name added to the plan they upgraded to if a special discount was given. Therefore, in order to simplify the variable, it was assigned "Basic" to all the rows containing "Basic", and "Growth Plan" to all the rows containing "Growth"
```{r}
str(wp_data$plan_name)
wp_data$plan_name <- as.factor(wp_data$plan_name)
levels(wp_data$plan_name)
wp_data$plan_name <- gsub(".*Basic.*", "Basic", wp_data$plan_name)
wp_data$plan_name <- gsub(".*Growth.*", "Growth Plan", wp_data$plan_name)
```

  When customers subscribe to Wishpond, they get to write the why they decide to subscribe to the platform. Below is the code to simplify all the different values entered, for easier understanding of the variable.
```{r}
# Code used to replace all the values that are related to the contest tool at Wishpond.
wp_data$interest <- gsub(".*coupon.*|.*photo.*|.*instagram*|.*referral.*|.*sweepstake.*|.*text.*|.*video.*|.*vote.*|.*pinterest.*", "Contest", wp_data$interest)

# Code used to replace all the values that are related to the pop-up tool
wp_data$interest <- gsub(".*forms.*|.*action*|.*pop.*", "Pop-Up", wp_data$interest)

# Code used to replace all the values that are related to the Landing Page tool
wp_data$interest <- gsub(".*landing.*", "Landing Page", wp_data$interest)

```

	
	In order to evaluate the total amount of live tools by each customer, live pop-ups, live workflow, live contests and live landing pages was combined into a unique variable total live tools.

```{r}
# Sum of all the live tools on Wishpond to total_live_tools
wp_data <- wp_data %>%  mutate(total_live_tools =  live_popups + live_workflows + live_landings + live_contests)
```


	There was too much differentiation on the amount of leads and amount of total live tools by each customer, making it harder to analyze the most frequent level for these two variable. Therefore, we decided to categorize into fewer levels based on a range of leads captured and total live tools.



  Business industry variable had too much differentiation and only a few industries had frequent values. Therefore, in order to evaluate the most frequent business industries it was used the group_by function to group the top 15 industries and then rename the other industries to “Other”

```{r}
# Discovering the top 15 business industries
# group by video ---> https://www.youtube.com/watch?v=jWjqLW-u3hc --> 24min
biz_grouped <- wp_data %>% group_by(business_industry) 
top_biz <- biz_grouped %>% count(business_industry) %>% arrange(desc(n))
top_15_biz <- head(top_biz, 15)

# Filtering the top 15 industries
top_biz_db <- wp_data %>% group_by(business_industry) %>% filter(n() >= 131, business_industry != "Unknown")
top_biz_col <- wp_data %>% group_by(business_industry) %>% filter(n() >= 131, business_industry != "Unknown") %>% select(pid, business_industry)

# Renaming businesses industry that are not part of the top 15
other_biz_col <- wp_data %>% group_by(business_industry) %>% filter(n() < 131, business_industry != "Unknown") %>% select(pid, business_industry)
other_biz_col$business_industry <-  "Other"
biz_unknown <- wp_data %>% filter(business_industry == "Unknown") %>% select(pid, business_industry)
biz_unknown$business_industry <- as.character(biz_unknown$business_industry)
top_biz_col$business_industry <- as.character(top_biz_col$business_industry)
other_biz_col$business_industry <- as.character(other_biz_col$business_industry)
all_biz <- bind_rows(top_biz_col, other_biz_col, biz_unknown)
wp_data$business_industry <- all_biz$business_industry
```

#### Fourth Part

	Lastly, some variables were renamed and rearranged for better visualization of the database.

```{r}
#Renaming column name
wp_data <- wp_data %>% rename( read_blog = has_seen_the_blog_overlay)
wp_data <- wp_data %>% rename( language = locale)
wp_data <- wp_data %>% rename( support_agent = support_agent_name)
wp_data <- wp_data %>% rename( cancel_contact_support = current_cancel_contact_support)
wp_data <- wp_data %>% rename( cancel_feeling = current_cancel_feeling)

#Rearranging the Data-base
wp_data <- wp_data %>% select(pid, business_industry, business_size, selected_service, live_workflows, live_popups, total_live_tools, live_contests, live_landings, total_leads, interest, read_blog, sales_agent, sales, affiliated, plan_name, website, support_agent, cancel_contact_support, cancel_feeling, Unsubscribed)
```

### Data Exploration

  In order to identify which data might be useful in predicting the main factors for someone to upgrade their account on Wishpond, exploratory analysis was performed to compare the different variables to the customers’ plan.

#####	All Wishpond Subscribers
  The graph below show us what the most popular plans at Wishpond are. The interesting thing here is that most of the customers are on the Starter plan, which means that they have not paid Wishpond yet. Even though starter plan does not contain much data, it shows a great opportunity for Wishpond to grow. If we understand what it takes customers to use Wishpond, we might be able to get people from the Starter plan to sign-up with Wishpond.

```{r}
wp_data_subscribed_all <- wp_data %>%  filter(Unsubscribed == "FALSE")
ggplot(wp_data_subscribed_all, aes(plan_name)) +
  geom_bar(stat = "count", aes(fill = plan_name)) +
  xlab("Plan Name") +
  ylab("") +
  scale_fill_discrete(name = "Plan Name") 
```

#####	Paying Subscribers
  Next we will focus on paying customers only. Thus, we will filter out all the “Unknown” and “Starters” values from plan name variable.

```{r }
wp_data_subscribed <- wp_data %>% filter(Unsubscribed == "FALSE", plan_name != "Unknown", plan_name != "Starter")
```

#####	Total Amount of Leads
  For this graph, we start with those who have acquired at least one lead, as if we count those who haven’t captured any lead, it will distort the graph as the number is much greater than any other. This is not the best signal as it means that there are lot of customers that are not being able to generate any lead.
  Another interesting point to analyze is that there are a lot of customers on the basic plan that have acquired more leads than the maximum allowed under their current plan (500 leads), which means that they upgraded their account to run a campaign and then went back to basic plan. 

```{r}
ggplot(wp_data_subscribed, aes(total_leads, fill = plan_name)) +
  geom_histogram(breaks = seq(1,20000, by = 100))  +
  labs(x = "Total Leads", y = "Count") +
  scale_fill_discrete(name = "Plan Name") 
```

#####	Total Amount of Live Tools
  For this graph, we start with those who have created at least 1 tool, because if we count those who haven’t created anything, it will distort the graph as the number of zero live tool is much greater than any other.
  Another interesting point to analyze is that most of those who have more than 25 live tools are on the Pro and Growth plan. 


```{r}
ggplot(wp_data_subscribed, aes(total_live_tools, fill = plan_name)) +
  geom_histogram(breaks = seq(1,150, by = 5)) +
  labs(x = "Total Live Tools", y = "Count") +
  scale_fill_discrete(name = "Plan Name")  
```

#####	Sales
  The graph shows that most of the subscriptions are not coming through sales agents, but through other means. The sales team is fairly expensive with a lot of personnel. Thus, Wishpond could reduce expenses by decreasing the sales team and increase revenue by focusing on the different avenues that are bringing more customers.

```{r}
ggplot(wp_data_subscribed, aes(factor(wp_data_subscribed$plan_name))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_subscribed$plan_name))) +
  facet_grid(. ~ factor(wp_data_subscribed$sales)) +
  xlab("Plan Name") +
  scale_fill_discrete(name = "Plan Name")     
```

#####	Affiliated
  While affiliated links have not generated as many sales as sales agents, the number are not too far off. Also, the amount of money spent on an affiliated link is much less than a sales agent salary. Pushing the affiliated program could be a good alternative to bring more customers to Wishpond at a lower cost.

```{r}
ggplot(wp_data_subscribed, aes(factor(wp_data_subscribed$plan_name))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_subscribed$plan_name))) +
  facet_grid(. ~ factor(wp_data_subscribed$affiliated)) +
  xlab("Plan Name") +
  ylab("") +
  scale_fill_discrete(name = "Plan Name")     
```

#####	Have Read Wishpond Blog
  The graph below shows us that those who have read the blog are generating more leads than those who have not read the blog. Thus, showing us that the blog might help customers to capture leads.

```{r}
ggplot(wp_data_subscribed, aes(total_leads, fill = plan_name)) +
  geom_histogram(breaks = seq(1,20000, by = 100))  +
  facet_grid(. ~ factor(wp_data_subscribed$read_blog)) +
  labs(title = "Have Read The Blog?", x = "Total Leads", y = "Count") +
  scale_fill_discrete(name = "Plan Name")
```

#####	Have Read Wishpond Blog and Total Amount of Leads
  The graph below shows us that those who have read the blog create more tools than those who have not. Thus, showing that the blog might influence on supporting customer to get started with Wishpond and create different tools on the platform. 

```{r}
ggplot(wp_data_subscribed, aes(total_live_tools, fill = plan_name)) +
  geom_histogram(breaks = seq(1,150, by = 5)) +
  facet_grid(. ~ factor(wp_data_subscribed$read_blog)) +
  labs(title = "Have Read The Blog?", x = "Total Live Tools", y = "Count") +
  scale_fill_discrete(name = "Plan Name")  
```

#####	Have Read Wishpond Blog and Total Amount of Leads
  Similar to the amount of leads, we want to see how the blog is influencing customers on creating different tools at Wishpond. The interesting factor on this graph is that most of the customers that have read the blog are not using Wishpond tools as much as those who have not read it. Therefore, Wishpond should allocate some space to talk about the importance of using workflows, pop-up and other tools, in order to get customers to use more of Wishpond tools.

```{r}
ggplot(wp_data_subscribed, aes(factor(wp_data_subscribed$total_live_tools))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_subscribed$total_live_tools))) +
  facet_grid(. ~ factor(wp_data_subscribed$read_blog)) +
  xlab("Total Live Tools") +
  ylab("") +
  scale_fill_discrete(name = "Total Live Tools")
```

#####	Business Industry At Each Plan
  From the graph below we can see that e-commerce is the leading business industry on Wishpond, while agency has a good share of customers. By analysing the graph for the starter plan, we can understand where most of the opportunity to turn customers to paid customers are, e-commerce and agency. At the Growth plan, the most expensive plan, e-commerce is by far the most predominant business industry. Thus, it allows us to see where Wishpond should start focusing in order to bring more customers.

###### Starter Plan & Business Industry
```{r}
wp_data_starter <- wp_data %>% filter(plan_name == "Starter", Unsubscribed == "FALSE", business_industry != "Other", business_industry != "Unknown")
ggplot(wp_data_starter, aes(factor(wp_data_starter$business_industry))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_starter$business_industry))) +
  facet_grid(. ~ factor(wp_data_starter$plan_name)) +
  xlab("business industry") +
  ylab("") +
  scale_fill_discrete(name = "business industry")     
```

###### Basic Plan & Business Industry 
```{r}
wp_data_basic <- wp_data %>% filter(plan_name == "Basic", Unsubscribed == "FALSE", business_industry != "Other", business_industry != "Unknown")
ggplot(wp_data_basic, aes(factor(wp_data_basic$business_industry))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_basic$business_industry))) +
  facet_grid(. ~ factor(wp_data_basic$plan_name)) +
  xlab("business industry") +
  ylab("") +
  scale_fill_discrete(name = "business industry")    
```

###### Pro Plan & Business Industry | Second Most Expensive Plan | E-Commerce by far the most relevant one. Art-design and fitness health industry coming in second
```{r}
wp_data_pro <- wp_data %>% filter(plan_name == "Pro", Unsubscribed == "FALSE", business_industry != "Other", business_industry != "Unknown")
ggplot(wp_data_pro, aes(factor(wp_data_pro$business_industry))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_pro$business_industry))) +
  facet_grid(. ~ factor(wp_data_pro$plan_name)) +
  xlab("business industry") +
  ylab("") +
  scale_fill_discrete(name = "business industry")     
```

###### Growth Plan & Business | Most Expensive Plan  | E-Commerce by far again bringing the most customers to Growth plan.
```{r}
wp_data_growth <- wp_data %>% filter(plan_name == "Growth Plan", Unsubscribed == "FALSE", business_industry != "Other", business_industry != "Unknown")
ggplot(wp_data_growth, aes(factor(wp_data_growth$business_industry))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_growth$business_industry))) +
  facet_grid(. ~ factor(wp_data_growth$plan_name)) +
  xlab("business industry") +
  ylab("") +
  scale_fill_discrete(name = "business industry")     
```

#####	Business Industry and Unsubscribed
  The graph below shows us that e-commerce and agency are the business industries with the most cancels, similar to the highest amount of customers. However, by knowing that these are the greatest numbers of cancel, we can learn what keep customers from these business industries subscribeed at Wishpond and eventually decrease the number of cancels.

```{r}
wp_data_unsubscribed <- wp_data %>% filter(Unsubscribed == "TRUE", business_industry != "Other", business_industry != "Unknown")
ggplot(wp_data_unsubscribed, aes(factor(wp_data_unsubscribed$business_industry))) +
  geom_bar(stat = "count", aes(fill = factor(wp_data_unsubscribed$business_industry))) +
  xlab("Business Industry") +
  ylab("") +
  scale_fill_discrete(name = "Business Industry")        
```

### Machine Learning 

#### Overview

##### This project will use machine learning to predict the risk of a customer unsubscribing from Wishpond. 

##### This is a supervised problem because we are attempting to predict a specific dependent variable using a model based on a set of independent variables.

##### This is a classfication problem

##### The independent variable is Unsubscribed, FALSE or TRUE.

##### This project used different techniques, first it used multiple imputation to replace the missing values with plausible values through probability. Secondly, it used Lasso Regularization to identify the variables that may cause overfitting to our model. Lastly, it used two different predictive models to evaluate which can perform better, logisitic regression and random forest regression. 

##### To test the predictive models, the data will be split into two different datasets train and test.

##### To evaluate the predictive models the data will be splitted into two different datasets train (holding larger data) and test (holding a smaller amount of data), in order to provide an unbiased evaluation of the final model.

##### After comparing the two models, random forest regression producde a better model than the logistic regression for over 1%, with an accuracy of 76.1%

#### Code

###### Because our goal is to identify who are at risk of unsubscribing, we will filter the database to those who are paying and who have unsubscribed from the platform

```{r}
wp_data_ml <- wp_data
wp_data_ml <- wp_data_ml %>% filter( plan_name == "Basic" | plan_name == "Pro" | plan_name == "Growth" | Unsubscribed == "TRUE")
```

###### The database has a lot of missing values, which are described as "Unknown" or as "Other" in the database. Therefore, we will replace these values with NAs in order to use multiple imputation and replace with predicted values rather than "Unknown" and "Other"

```{r}
wp_data_ml[wp_data_ml == "Unknown"] <- NA
wp_data_ml[wp_data_ml == "Other"] <- NA
```

###### Some support agents have really low amount of customers because they are no longer with the company. Therefore, we will exclude those with minimun amount of customer to be replaced with NA and later be replaced with multiple imputation.

```{r}
support_agent_del <- wp_data_ml %>% group_by(support_agent) %>% filter(n() < 10)
support_agent_del$support_agent <- NA
support_agent_ml <- wp_data_ml %>% group_by(support_agent)  %>% filter(n() >= 10)
support_agent_ml <- bind_rows(support_agent_del, support_agent_ml)
wp_data_ml$support_agent <- support_agent_ml$support_agent
```

###### When customers unsubscribe, they are automatically sent to Starter plan, which means that Starter is not the plan they were subscribed to. Thus, we will turn all the starters plan to NAs and then use multiple imputation to replace it with the possible plans the were once subscribed to.

```{r}
wp_data_ml$plan_name[wp_data_ml$plan_name == "Starter"] <- NA
```

###### Most of the variable in the database are represented as characters, and to use the multiple imputation function, we will need to transform them into factors.
```{r}
wp_data_ml[c(2:4, 11:21)] <- lapply(wp_data_ml[c(2:4, 11:21)], as.factor)
```

###### To use multiple imputation, we will select all the variables that have missing values into a new database, then we will run the function on those variables. After that, we will replace the new variables into the real database.

###### Basically, what multiple imputation will do is to replace missing values with plausible values through probability.

```{r echo=TRUE, results="hide"}
library("mice")
```

```{r echo=TRUE, results="hide"}
simple <- wp_data_ml[c("business_industry", "business_size", "interest", "sales_agent", "plan_name", "website", "support_agent", "cancel_feeling")]
set.seed(98)
imputed <- mice::complete(mice(simple))
```

Now, we will replace the old variables with missing data with the new imputed variables that have no NAs.

```{r}
wp_data_ml$business_industry <- imputed$business_industry
wp_data_ml$business_size <- imputed$business_size
wp_data_ml$interest <- imputed$interest
wp_data_ml$sales_agent <- imputed$sales_agent
wp_data_ml$website <- imputed$website
wp_data_ml$support_agent <- imputed$support_agent
wp_data_ml$cancel_feeling <- imputed$cancel_feeling
wp_data_ml$plan_name <- imputed$plan_name
```

###### There are some variables that are not needed and therefore, we will exclude from the database. All the variables with live related tools are going to  be exlcuded because it doesnt reflect the amount of live tools customers had correctly since when a customer unsubscribe it is automatically set to 0.

```{r}
wp_data_ml <- wp_data_ml %>% select(-pid, -selected_service, -live_workflows, -live_popups, -live_contests, -live_landings, -total_live_tools)
```

###### Before applying regression analysis, we will run Lasso Regularization to see what variables may cause overfitting in our model, thus indicating which variables will best fit our model.

####### In order to run Lasso we need all variables to be integers. 
```{r echo=TRUE, results="hide"}
library(glmnet)
```      


```{r}
wp_data_num <- wp_data_ml
wp_data_num[c(1:2, 4:14)] <- lapply(wp_data_num[c(1:2, 4:14)], as.integer)
wp_data_num[c(1:2, 4:14)] <- wp_data_num[c(1:2, 4:14)] - 1
wp_data_num[c(1:2, 4:14)] <- lapply(wp_data_num[c(1:2, 4:14)], as.integer)
```

####### Then we need to separate the independent variable from the dependent variables

```{r}
unsubscribed_db <- wp_data_num$Unsubscribed
wp_data_num <- wp_data_num %>% select(-Unsubscribed)
```

####### Now we will run a cv.glmnet function to identify the best lambda values, which can be identified through the graph, below. The line of the left shows us the lambda value with the minimun misclassification errors, while the line on the right shows us the most regularized model that is still within 1 standard error from our lambda value with minimun misclassification error.

```{r}
CV <- cv.glmnet(as.matrix(wp_data_num), unsubscribed_db, family="binomial", type.measure = "class", alpha = 1, nlambda=100)
plot(CV)
```

####### On the function below we will use the lambda values we found on the function above to show us what are the variables that may cause overfitting in our model. The variables that may cause overfitting will be shown with a coefficient of 0.

```{r}
fit <- glmnet(as.matrix(wp_data_num), unsubscribed_db, family="binomial", alpha = 1, lambda=CV$lambda.1se)
fit$beta[,1]
```

###### Now for the regression analysis, we will split the database into a training dataset and test dataset. And because we have a large database, we decided to use a split ratio of 65% on the training database and 35% on the test database.
```{r}
set.seed(1000)
split <- sample.split(wp_data_ml$Unsubscribed, SplitRatio = 0.65)
train <- subset(wp_data_ml, split == TRUE)
test <- subset(wp_data_ml, split == FALSE)
```

###### Below, is the logistic regression function, comparing the independent variable "Unsubscribed" against all the other dependent variables.
```{r}
wp_data_Log <- glm(Unsubscribed ~ business_industry + total_leads + interest + sales_agent + sales + affiliated + website + support_agent + cancel_contact_support, data = train, family = binomial)
summary(wp_data_Log)
```

###### From the function above we can observe some important correlations, they are: 
####### - There is a high correlation that customers that have their own website, tend to stay subscribed with Wishpond.
####### - If a customer subscribe after coming from a demo with one of the sales agent there is a significant correlation of them staying subscribed
####### - There is a high correlation of remaining subscribed if a customer main interest to subscribe to Wishpond is to build a Landing Page or Pop-Up
####### - There is a high correlation that unsubscribed customers have talked to a support agent before unsubscribing.

###### Now, we will use the predict test to see how many customer are in risk of unsubscribing and then we will evaluate the accuracy of model by using the table function and a threshold of 50%, since we have no preference of errors in the database. 
```{r}
predicTest <- predict(wp_data_Log, type="response", newdata = test)
# Accuracy
table(test$Unsubscribed, predicTest > 0.5)

# Accuracy of 74.9%
(149+811)/(811+149+224+97)

# Baseline Method - 70.8%. Therefore, our model beats the baseline method by 4%, showing some sigificance.
(97+811)/(811+149+224+97)
```

###### To analyze if the model can differentiate from high-risk to low-risk to unsubscribe customers, we will use prediction function from ROCpred library.
```{r}
ROCRpred <- prediction(predicTest, test$Unsubscribed)
as.numeric(performance(ROCRpred, "auc")@y.values)
```

###### Our model shows that our accuracy beats our baseline method by only 2% and the ROCR shows that the model can differentiate with 62% from the subscribed and unsubscribed customers. 

###### Therefore, in order to see if we can increase the relevance of our model, we will compare logistic regression with random forest regression.

```{r echo=FALSE}
library(randomForest)
```

```{r}
wp_data_forest <- randomForest(Unsubscribed ~ business_industry + total_leads + interest + sales_agent + sales + affiliated + website + support_agent + cancel_contact_support, data = train, nodesize=25, ntree=200)
PredictForest = predict(wp_data_forest, newdata = test)
table(test$Unsubscribed, PredictForest)

# Accuracy from Random Forest Model is 76.1%, which improves our predictability by just over 1% when comparing to the logistic regression.
(155+820)/(820+155+218+88)

# Our model beat baseline by 6%, which means our model did better than the baseline method.
(88+820)/(820+155+218+88)
```


###### By using the function above, we can see that Random Forest regression improves our model by 1% when comparing to logistic regression, to a total of 73% accuracy.


### Recommendation

#### From the machine learning analysis we were able to see that there is a high rate of customers unsubscribing from the platform, and if nothing changes 70% of the customers will continue to unsubscribe from the platform. 

#### However, from our model we observed that there independent variables with significant correlation that encourages clients to remain subscribed. Moreover, based on the findings we will provide four recommendations to Wishpoond.

##### First, increase focus on those who are interested in building Landing Pages and Pop-ups, as both shows high correlation with remaining subscribed to Wishpond. The increase in focus can be done by focusing marketing efforts such as ads and blogs towards people that are interest in landing pages and pop-ups.

##### Second, similar to the recommendation above, marketing efforts should also focus on businesses that have own have own a domain or just purchased a domain. To reach this audience the marketing team could create content on how Wishpond can integrate with their website and paid ads to those that are engaged with domain related platforms. 

##### Third, marketing efforts should not only be focuse on acquiring new leads, but should also focus getting the lead to book a demo with a sales agent. This can be done via email marketing campaign to get them to book a demo and automated SMS to remind leads about their demo. 

##### Last but nont least, there were a lot of missing data, and the accuracy results could be improved if data from unsubscribed customers were automatically set to 0. Therefore, we recommend saving the data right at the moment the customer decide to unsubscribe from the platform, giving us more insights on what they did and the reason the might have cancelled.